<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pujo ‚Äî Listen & Tap (Bengali) ‚Äî All-in-one</title>
<style>
  :root{--accent:#0f172a;--muted:#666;--bg:#fff7f0}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:#111}
  .wrap{max-width:1100px;margin:0 auto;padding:12px;display:flex;flex-direction:column;min-height:100vh}
  header{display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap}
  .title{font-weight:900;font-size:18px}
  .subtitle{font-size:13px;color:var(--muted)}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#111;cursor:pointer;font-weight:800;white-space:nowrap}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .pill{background:#f3f3f3;padding:6px 10px;border-radius:999px;font-weight:800;display:inline-flex;align-items:center;gap:8px}
  .levels{display:flex;gap:8px;align-items:center}
  .level-btn{padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:800;color:#111}
  .level-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  main{flex:1; display:flex; flex-direction:column}
  .grid-wrap{flex:1; overflow:auto;padding-top:10px;padding-bottom:10px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:0 auto;max-width:1100px;padding:4px}
  @media(min-width:640px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media(min-width:900px){ .grid{grid-template-columns:repeat(4,1fr)} }
  .card{border-radius:12px;overflow:hidden;border:1px solid #eee;background:#fff;display:flex;flex-direction:column;cursor:pointer;height:132px}
  @media(min-width:640px){ .card{height:170px} }
  @media(min-width:900px){ .card{height:200px} }
  .imgwrap{height:calc(100% - 36px);overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff}
  .imgwrap img{width:100%;height:100%;object-fit:contain;object-position:center}
  .label{height:36px;line-height:18px;padding:6px 8px;text-align:center;font-weight:800;font-size:13px;background:linear-gradient(180deg,transparent,rgba(255,255,255,0.9));white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .training-panel{display:none;margin-top:12px;padding:12px;border-radius:12px;background:#fff;border:1px solid #eee}
  .training-large{display:flex;align-items:center;justify-content:center;margin-bottom:8px}
  .training-large img{width:100%;max-width:720px;max-height:60vh;object-fit:contain;border-radius:8px}
  .training-thumb-row{display:flex;gap:8px;overflow:auto;padding:6px 0}
  .thumb{flex:0 0 auto;width:84px;text-align:center}
  .thumb img{width:84px;height:64px;object-fit:cover;border-radius:6px;border:2px solid transparent}
  .thumb.current img{border-color:var(--accent)}
  .status{margin-top:12px;padding:10px;border-radius:8px;background:#fffef8;border:1px solid #ffe8b5}
  .footer{margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-radius:4px;background:transparent}
  .footer .credit{font-size:12px;color:#fff;background:#000;padding:6px 8px;border-radius:3px;text-align:center;width:100%}
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:1200;padding:12px}
  .modal{background:#fff;padding:14px;border-radius:10px;max-width:920px;width:100%;max-height:86vh;overflow:auto;font-size:13px}
  input[type="text"]{padding:8px;border-radius:8px;border:1px solid #ddd;font-size:13px}
  footer.sitefoot{margin-top:8px}
  @media(max-width:640px){
    .card{height:140px}
    .controls{gap:6px}
    .label{font-size:12px}
    .footer .credit{font-size:11px;padding:6px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">üëÇ Pujo ‚Äî Listen & Tap (Bengali)</div>
      <div class="subtitle">Tap the picture that matches the spoken Bengali word.</div>
    </div>

    <div class="controls" role="region" aria-label="Top controls">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">‚è± <b id="timer">0</b>s</div>

      <button id="trainToggle" class="btn" aria-pressed="false">Training</button>
      <button id="leaderboardBtn" class="btn">Leaderboard</button>
      <button id="shareBtn" class="btn">Share</button>
      <button id="certBtn" class="btn">Certificate</button>

      <button id="startBtn" class="btn" aria-pressed="false">Start</button>
      <button id="muteBtn" class="btn">üîä On</button>
    </div>
  </header>

  <div style="margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <div id="levelsWrapper" class="levels" role="tablist" aria-label="Levels">
      <button id="lvl1" class="level-btn active" data-level="1">Level 1</button>
      <button id="lvl2" class="level-btn" data-level="2">Level 2</button>
      <button id="lvl3" class="level-btn" data-level="3">Level 3</button>
    </div>
    <div class="small">Level 1 ‚Äî 60s up to 15 items. Level 2 ‚Äî 120s up to 30 items. Level 3 ‚Äî 180s all items (labels hidden).</div>
  </div>

  <main>
    <div class="grid-wrap">
      <div id="grid" class="grid" aria-live="polite" aria-label="Game grid">[Grid items load here...]</div>
    </div>

    <section id="trainingPanel" class="training-panel" aria-hidden="true">
      <div class="training-large">
        <img id="trainingLarge" src="" alt="Training preview">
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="trainPlay" class="btn">‚ñ∂ Play</button>
        <button id="trainPause" class="btn" disabled>‚è∏ Pause</button>
        <button id="trainPrev" class="btn">Prev</button>
        <button id="trainNext" class="btn">Next</button>
        <label class="small">Delay:
          <select id="trainDelay" class="btn" style="padding:6px 8px;margin-left:6px">
            <option value="600">0.6s</option>
            <option value="800">0.8s</option>
            <option value="1000" selected>1.0s</option>
            <option value="1400">1.4s</option>
          </select>
        </label>
        <button id="trainStop" class="btn">Stop</button>
      </div>
      <div id="trainingPreview" class="training-thumb-row" style="margin-top:10px"></div>
    </section>

    <div id="status" class="status" aria-live="polite">Status: Ready ‚Äî press Start to begin. (Audio will be enabled by Start.)</div>
  </main>

  <footer class="sitefoot">
    <div class="footer">
      <div class="credit">Created and Designed by Animesh, Audio Credits ‚Äî My Daughter Ishani</div>
    </div>
  </footer>
</div>

<div id="modal" class="modal-back" role="dialog" aria-hidden="true">
  <div class="modal" id="modalContent"></div>
</div>

<canvas id="certCanvas" style="display:none"></canvas>

<script>
/* =========================
   Data and config
   ========================= */
const ITEMS = [
  'prodip','kashphool','dhak','kansorghonta','shankho','kolabou','dhunuchi','pushpo','fol',
  'mishti','peda','batasha','alpona','chandmala','saree','punjabi','alta','trishul','bhog',
  'kosha_kushi','bel_pata','aam_pollob','tulsi_pata','padma_phool','108_prodip','pan_supari',
  'dhan','durba_ghas','chondon_kath_chondon_piri','ghot','narkel','dab','swastik_chinho',
  'sindur','gamcha','pandel','bansh','shal_pata','mondir','onusthan_suchi','roshid_ba_chandar_boi',
  'thakurer_kathamo','onjoli_ba_pushpanjoli','aroti','poncho_prodip'
];
const LEVELS = {1:{secs:60,maxItems:15},2:{secs:120,maxItems:30},3:{secs:180,maxItems:ITEMS.length}};
const LB_KEY = 'pujo_leaderboard_v1';

/* =========================
   UI refs & state
   ========================= */
const grid = document.getElementById('grid');
const startBtn = document.getElementById('startBtn');
const muteBtn = document.getElementById('muteBtn');
const trainToggle = document.getElementById('trainToggle');
const trainingPanel = document.getElementById('trainingPanel');
const trainingLarge = document.getElementById('trainingLarge');
const trainingPreview = document.getElementById('trainingPreview');
const trainPlay = document.getElementById('trainPlay');
const trainPause = document.getElementById('trainPause');
const trainPrev = document.getElementById('trainPrev');
const trainNext = document.getElementById('trainNext');
const trainStop = document.getElementById('trainStop');
const trainDelay = document.getElementById('trainDelay');
const statusEl = document.getElementById('status');
const scoreEl = document.getElementById('score');
const timerEl = document.getElementById('timer');
const leaderboardBtn = document.getElementById('leaderboardBtn');
const shareBtn = document.getElementById('shareBtn');
const certBtn = document.getElementById('certBtn');
const levelBtns = Array.from(document.querySelectorAll('.level-btn'));
const levelsWrapper = document.getElementById('levelsWrapper');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const certCanvas = document.getElementById('certCanvas');

let selectedLevel = 1;
let playing = false;
let secs = 0;
let score = 0;
let timer = null;
let currentTarget = null;
let targetPool = [];
let audioCtx = null;
let audioBuffers = {};
let htmlAudio = {};
let preloadedImages = {};
let aggressiveAllowed = false;
let trainIndex = 0;
let trainPlaying = false;
let trainTimer = null;
let soundOn = true;
let activeSource = null;

/* =========================
   Helpers
   ========================= */
function shuffle(a){ return a.slice().map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* =========================
   Audio (mp3 under audio/bn/)
   ========================= */
function ensureAudioContext(){
  if(audioCtx) return audioCtx;
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return null;
    audioCtx = new AC();
    if(audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); }
    return audioCtx;
  }catch(e){
    audioCtx = null;
    return null;
  }
}
function stopAllAudio(){
  try{
    if(activeSource && activeSource.stop){ try{ activeSource.stop(0); }catch(e){} activeSource = null; }
  }catch(e){}
  Object.values(htmlAudio).forEach(a=>{ try{ a.pause(); a.currentTime = 0; }catch(e){} });
}
async function fetchAndMaybeDecode(key){
  if(audioBuffers[key] || htmlAudio[key]) return;
  const url = `audio/bn/${key}.mp3`;
  try{
    const res = await fetch(url, {cache:'force-cache'});
    if(!res.ok) throw new Error('fetch status ' + res.status);
    const ab = await res.arrayBuffer();
    if(aggressiveAllowed && ensureAudioContext()){
      try{
        const decoded = await audioCtx.decodeAudioData(ab);
        audioBuffers[key] = decoded;
        return;
      }catch(e){}
    }
    const a = new Audio(url); a.preload = 'auto'; htmlAudio[key] = a;
  }catch(e){
    try{ const aa = new Audio(url); aa.preload='auto'; htmlAudio[key] = aa; }catch(err){}
  }
}
function playBufferOrHtml(key){
  return new Promise(async (resolve)=>{
    if(!soundOn){ resolve(); return; }
    stopAllAudio();
    if(audioBuffers[key] && ensureAudioContext()){
      try{
        const src = audioCtx.createBufferSource();
        src.buffer = audioBuffers[key];
        const gain = audioCtx.createGain(); gain.gain.value = 1;
        src.connect(gain).connect(audioCtx.destination);
        activeSource = src;
        src.onended = ()=>{ activeSource = null; resolve(); };
        src.start(0);
        return;
      }catch(e){}
    }
    try{
      const a = htmlAudio[key] || new Audio(`audio/bn/${key}.mp3`);
      htmlAudio[key] = a;
      a.onended = ()=>resolve();
      a.onerror = ()=>{ resolve(); };
      const p = a.play();
      if(p && p.catch) p.catch(()=>resolve());
    }catch(e){ resolve(); }
  });
}
async function speakItem(key){
  if(!key) return;
  try{
    await fetchAndMaybeDecode(key);
    await playBufferOrHtml(key);
  }catch(e){
    try{
      if('speechSynthesis' in window){
        stopAllAudio();
        const u = new SpeechSynthesisUtterance(key.replace(/_/g,' '));
        u.lang = 'en-GB';
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
        await new Promise(r=>{ u.onend = r; setTimeout(r,1200); });
      }
    }catch(err){}
  }
}

/* =========================
   Images
   ========================= */
const PLACEHOLDER_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
  '<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600"><rect fill="#f3f3f3" width="100%" height="100%"/><text x="50%" y="50%" font-size="28" fill="#777" text-anchor="middle" dy="8">Image not found</text></svg>'
);
function capabilityCheck(){ const mem = navigator.deviceMemory || 0; const cores = navigator.hardwareConcurrency || 0; return (mem>=4||cores>=4); }
function preloadImages(keys){ keys.forEach(k=>{ if(preloadedImages[k]) return; const img=new Image(); img.src=`images/pujo/${k}.jpg`; preloadedImages[k]=img; }); }
async function backgroundPreload(){
  aggressiveAllowed = capabilityCheck();
  const first = ITEMS.slice(0,6);
  preloadImages(first);
  await Promise.all(first.map(k=>fetchAndMaybeDecode(k))).catch(()=>{});
  if(aggressiveAllowed){
    for(let i=0;i<ITEMS.length;i+=6){
      const set = ITEMS.slice(i,i+6); preloadImages(set); await Promise.all(set.map(k=>fetchAndMaybeDecode(k))).catch(()=>{}); await new Promise(r=>setTimeout(r,180));
    }
  } else {
    for(let i=0;i<ITEMS.length;i+=4){
      const set = ITEMS.slice(i,i+4); preloadImages(set); await Promise.all(set.map(k=>fetchAndMaybeDecode(k))).catch(()=>{}); await new Promise(r=>setTimeout(r,600));
    }
  }
}
function ensureImageAvailable(key, timeoutMs = 2000) {
  return new Promise((resolve) => {
    const url = `images/pujo/${key}.jpg`;
    const img = new Image();
    let done = false;
    const to = setTimeout(()=>{ if(!done){ done = true; img.onload = img.onerror = null; resolve(false); } }, timeoutMs);
    img.onload = () => { if(done) return; done = true; clearTimeout(to); resolve(true); };
    img.onerror = () => { if(done) return; done = true; clearTimeout(to); resolve(false); };
    img.src = url;
  });
}

/* =========================
   Grid & Game logic
   ========================= */
function buildGrid(keys){
  grid.innerHTML = '';
  const hideLabels = selectedLevel === 3;
  preloadImages(keys);
  keys.forEach((k,i)=>{
    const c = document.createElement('button'); c.className = 'card'; c.type='button'; c.dataset.key = k;
    const iw = document.createElement('div'); iw.className = 'imgwrap';
    const img = document.createElement('img'); img.alt = k;
    if(preloadedImages[k] && preloadedImages[k].src) img.src = preloadedImages[k].src;
    else img.src = `images/pujo/${k}.jpg`;
    img.onerror = () => { img.onerror = null; img.src = PLACEHOLDER_SVG; };
    iw.appendChild(img);
    c.appendChild(iw);
    const lbl = document.createElement('div'); lbl.className = 'label'; lbl.textContent = k;
    if(hideLabels) lbl.style.display = 'none';
    c.appendChild(lbl);
    c.addEventListener('click', ()=>onTileClick(k));
    grid.appendChild(c);
  });
}
function makeRoundPool(){
  if(!targetPool || targetPool.length === 0){
    const cfg = LEVELS[selectedLevel];
    const poolSize = Math.min(cfg.maxItems, ITEMS.length);
    targetPool = shuffle(ITEMS).slice(0, poolSize);
  }
  return targetPool.shift();
}
async function startNextRound(){
  if(!playing) return;
  let attempts = 0, candidate = null;
  while(attempts < 8){
    attempts++;
    candidate = makeRoundPool();
    if(!candidate) break;
    const ok = await ensureImageAvailable(candidate, 1200);
    if(ok) break;
    candidate = null;
  }
  if(!candidate){
    const keys = shuffle(ITEMS).slice(0,4);
    buildGrid(keys);
    currentTarget = keys[0];
    statusEl.textContent = 'Listen and tap the matching image (some images unavailable)';
    await speakItem(currentTarget);
    return;
  }
  currentTarget = candidate;
  const distractors = [];
  const candidates = shuffle(ITEMS.filter(x=>x!==currentTarget));
  for(let i=0; i<candidates.length && distractors.length<3; i++){
    const d = candidates[i];
    const ok = await ensureImageAvailable(d, 900);
    if(ok) distractors.push(d);
  }
  if(distractors.length < 3){
    const extras = shuffle(ITEMS.filter(x=>x!==currentTarget && distractors.indexOf(x)===-1)).slice(0, 3 - distractors.length);
    distractors.push(...extras);
  }
  const keys = shuffle([currentTarget, ...distractors]).slice(0,4);
  buildGrid(keys);
  statusEl.textContent = 'Listen and tap the matching image';
  await speakItem(currentTarget);
}
function onTileClick(key){
  if(!playing && trainingPanel.style.display === 'block'){
    pauseTraining();
    showTrainingLarge(key);
    speakItem(key);
    return;
  }
  if(!playing) return;
  if(!currentTarget) return;
  if(key === currentTarget){
    score++; scoreEl.textContent = score;
    statusEl.textContent = '‚úÖ ' + pick(['Brilliant!','Great!','Nice!','Super!']);
    setTimeout(()=>{ if(playing) startNextRound(); }, 350);
  } else {
    score = Math.max(0, score-1); scoreEl.textContent = score;
    statusEl.textContent = pick(['Almost‚Äîtry again!','So close!','Keep going!']);
  }
}
function computeFinalScore(scoreVal, timeRem){ return (scoreVal * 1000) + Math.floor(Math.max(0,timeRem) * 5); }

/* =========================
   Start / Stop / Levels behavior
   ========================= */
function startGame(){
  ensureAudioContext();
  stopAllAudio();
  playing = true; score = 0; scoreEl.textContent = 0;
  const cfg = LEVELS[selectedLevel];
  secs = cfg.secs; timerEl.textContent = secs;
  targetPool = shuffle(ITEMS).slice(0, Math.min(cfg.maxItems, ITEMS.length));
  statusEl.textContent = 'Game started ‚Äî listen for the item';
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{
    secs--; timerEl.textContent = secs;
    if(secs <= 0){
      clearInterval(timer);
      playing = false;
      startBtn.textContent = 'Start';
      startBtn.classList.remove('primary');
      const final = computeFinalScore(score, secs);
      const msg = score < 5 ? pick(['You are my buddy ‚ù§Ô∏è Let\'s play again, shall we?','Great try!']) : pick(['Wow! You crushed it! üèÜ','Amazing score!']);
      statusEl.textContent = `Time‚Äôs up: Your score is ${score}. ${msg}`;
      saveResultToLeaderboard({name:'Anonymous',score, timeRemaining:secs, finalScore:final, level:selectedLevel, when:Date.now()});
      openResultModal(score, secs, final);
    }
  }, 1000);
  startBtn.textContent = 'Stop';
  startBtn.classList.add('primary');
  startBtn.setAttribute('aria-pressed','true');
  startNextRound();
}
function stopGame(){
  playing = false;
  if(timer) clearInterval(timer);
  stopAllAudio();
  startBtn.textContent = 'Start';
  startBtn.classList.remove('primary');
  startBtn.setAttribute('aria-pressed','false');
  statusEl.textContent = 'Stopped. Press Start to play again.';
}
startBtn.addEventListener('click', ()=>{
  // If training open, prevent start (avoids confusion)
  if(trainingPanel.style.display === 'block') { return; }
  if(!playing) startGame(); else stopGame();
});

/* mute */
muteBtn.addEventListener('click', ()=>{
  soundOn = !soundOn;
  muteBtn.textContent = soundOn ? 'üîä On' : 'üîá Off';
  if(!soundOn) stopAllAudio();
});

/* level selection */
levelBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    levelBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    selectedLevel = Number(b.dataset.level);
    statusEl.textContent = `Level ${selectedLevel} selected. Press Start.`;
    buildGrid(ITEMS.slice(0,4));
  });
});

/* =========================
   Training module (fixed & improved)
   ========================= */
function openTraining(){
  trainingPanel.style.display = 'block';
  trainingPanel.setAttribute('aria-hidden','false');
  document.querySelector('.grid-wrap').style.display = 'none';
  // Hide levels to avoid confusion
  levelsWrapper.style.display = 'none';
  trainToggle.classList.add('primary');
  trainToggle.setAttribute('aria-pressed','true');
  startBtn.disabled = true;
  renderTrainingPreview();
  trainIndex = 0;
  showTrainingLarge(ITEMS[0]);
  statusEl.textContent = 'Training mode: previewing items';
}
function closeTraining(){
  trainingPanel.style.display = 'none';
  trainingPanel.setAttribute('aria-hidden','true');
  document.querySelector('.grid-wrap').style.display = '';
  levelsWrapper.style.display = '';
  trainToggle.classList.remove('primary');
  trainToggle.setAttribute('aria-pressed','false');
  startBtn.disabled = false;
  stopTraining();
  statusEl.textContent = 'Training closed';
}
trainToggle.addEventListener('click', ()=>{
  const open = trainingPanel.style.display === 'block';
  if(open) closeTraining(); else openTraining();
});

/* previews */
function renderTrainingPreview(){
  trainingPreview.innerHTML = '';
  ITEMS.forEach((k, idx)=>{
    const d = document.createElement('div'); d.className = 'thumb';
    const img = document.createElement('img'); img.alt = k; img.src = `images/pujo/${k}.jpg`;
    img.addEventListener('error', ()=>{ img.style.opacity = 0.45; img.src = PLACEHOLDER_SVG; });
    d.appendChild(img);
    d.addEventListener('click', ()=>{ pauseTraining(); trainIndex = idx; showTrainingLarge(k); speakItem(k); });
    trainingPreview.appendChild(d);
  });
}
function showTrainingLarge(key){
  const src = (preloadedImages[key] && preloadedImages[key].src) ? preloadedImages[key].src : `images/pujo/${key}.jpg`;
  trainingLarge.src = src;
  Array.from(trainingPreview.children).forEach((n,i)=> n.classList.toggle('current', ITEMS[i]===key));
  const idx = ITEMS.indexOf(key);
  if(idx >= 0) trainingPreview.children[idx].scrollIntoView({behavior:'smooth', inline:'center'});
}

async function trainingLoop(){
  while(trainPlaying){
    const key = ITEMS[trainIndex];
    showTrainingLarge(key);
    await fetchAndMaybeDecode(key).catch(()=>{});
    await speakItem(key);
    if(!trainPlaying) break;
    const delay = Number(trainDelay.value) || 1000;
    await new Promise(r => trainTimer = setTimeout(r, delay));
    trainIndex = (trainIndex + 1) % ITEMS.length;
  }
}
function startTraining(){ if(trainPlaying) return; trainPlaying = true; trainPlay.disabled=true; trainPause.disabled=false; trainingLoop(); }
function pauseTraining(){ trainPlaying = false; trainPlay.disabled=false; trainPause.disabled=true; if(trainTimer){ clearTimeout(trainTimer); trainTimer=null; } stopAllAudio(); }
function stopTraining(){ pauseTraining(); trainIndex = 0; trainingLarge.src=''; Array.from(trainingPreview.children).forEach(n=> n.classList.remove('current')); }

trainPlay.addEventListener('click', ()=>{ if(trainingPanel.style.display!=='block') openTraining(); startTraining(); });
trainPause.addEventListener('click', pauseTraining);
trainNext.addEventListener('click', ()=>{ pauseTraining(); trainIndex=(trainIndex+1)%ITEMS.length; showTrainingLarge(ITEMS[trainIndex]); speakItem(ITEMS[trainIndex]); });
trainPrev.addEventListener('click', ()=>{ pauseTraining(); trainIndex=(trainIndex-1+ITEMS.length)%ITEMS.length; showTrainingLarge(ITEMS[trainIndex]); speakItem(ITEMS[trainIndex]); });
trainStop.addEventListener('click', ()=>{ stopTraining(); });

/* =========================
   Leaderboard, sharing, certificate (same as before)
   ========================= */
function saveResultToLeaderboard(entry){
  try{
    const lb = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
    lb.push(entry);
    lb.sort((a,b)=> b.finalScore - a.finalScore || b.score - a.score || a.timeRemaining - b.timeRemaining);
    localStorage.setItem(LB_KEY, JSON.stringify(lb.slice(0,200)));
  }catch(e){}
}
function loadLeaderboard(){ try{ return JSON.parse(localStorage.getItem(LB_KEY) || '[]'); }catch(e){ return []; } }

function openResultModal(scoreVal,timeRem,finalScoreVal){
  const badge = finalScoreVal >= 20000 ? 'Gold' : finalScoreVal >= 12000 ? 'Silver' : 'Bronze';
  const html = `
    <h2>Round complete</h2>
    <p>Score: <b>${scoreVal}</b> ‚Ä¢ Time remaining: <b>${timeRem}</b>s ‚Ä¢ Final score: <b>${finalScoreVal}</b></p>
    <p>Badge: <b>${badge}</b></p>
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input id="playerName" placeholder="Your name (optional)" style="padding:8px;border:1px solid #ddd;border-radius:8px;width:220px" />
      <button id="saveScoreBtn" class="btn">Save</button>
      <button id="shareLinkBtn" class="btn">Share</button>
      <button id="downloadCertBtn" class="btn">Certificate</button>
      <button id="closeModalBtn" class="btn">Close</button>
    </div>
  `;
  openModal(html);
  document.getElementById('closeModalBtn').addEventListener('click', closeModal);
  document.getElementById('saveScoreBtn').addEventListener('click', ()=>{
    const name = document.getElementById('playerName').value.trim() || 'Anonymous';
    saveResultToLeaderboard({name,score:scoreVal,timeRemaining:timeRem,finalScore:finalScoreVal,level:selectedLevel,when:Date.now()});
    alert('Saved to local leaderboard');
    closeModal();
  });
  document.getElementById('shareLinkBtn').addEventListener('click', ()=>{
    const payload = {name:(document.getElementById('playerName').value.trim()||'Anonymous'),score:scoreVal,timeRemaining:timeRem,finalScore:finalScoreVal,level:selectedLevel,when:Date.now()};
    const url = generateShareURL(payload);
    if(navigator.share){ navigator.share({title:'Pujo score',text:`I scored ${payload.score}`,url}).catch(()=>copyToClipboard(url).then(()=>alert('Link copied'))); }
    else copyToClipboard(url).then(()=>alert('Link copied')).catch(()=>prompt('Copy this link:', url));
  });
  document.getElementById('downloadCertBtn').addEventListener('click', ()=>{
    const name = document.getElementById('playerName').value.trim() || 'Anonymous';
    generateCertificate(name, selectedLevel, scoreVal, timeRem, finalScoreVal);
  });
}

leaderboardBtn.addEventListener('click', ()=>{
  const lb = loadLeaderboard();
  const rows = lb.map((r,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.score}</td><td>${r.timeRemaining}s</td><td>${r.finalScore}</td><td>${r.level}</td><td>${new Date(r.when).toLocaleString()}</td></tr>`).join('') || '<tr><td colspan="7">No entries</td></tr>';
  const html = `<h2>Local Leaderboard</h2><div style="overflow:auto"><table style="width:100%;border-collapse:collapse"><thead><tr><th>#</th><th>Name</th><th>Score</th><th>Time</th><th>Final</th><th>Level</th><th>When</th></tr></thead><tbody>${rows}</tbody></table></div><div style="margin-top:10px;display:flex;gap:8px"><button id="exportBtn" class="btn">Export JSON</button><button id="closeLB" class="btn">Close</button></div>`;
  openModal(html);
  document.getElementById('closeLB').addEventListener('click', closeModal);
  document.getElementById('exportBtn').addEventListener('click', ()=>{ const data = JSON.stringify(lb, null, 2); downloadText('pujo_leaderboard.json', data); });
});

shareBtn.addEventListener('click', ()=>{
  const lb = loadLeaderboard();
  const last = lb[0];
  if(!last){ copyToClipboard(location.href).then(()=>alert('Game link copied')); return; }
  const url = generateShareURL(last);
  copyToClipboard(url).then(()=>alert('Share link copied!'));
});

certBtn.addEventListener('click', ()=>{
  const lb = loadLeaderboard();
  if(!lb[0]){ alert('No saved result yet'); return; }
  const r = lb[0];
  generateCertificate(r.name || 'Player', r.level, r.score, r.timeRemaining, r.finalScore);
});

function generateShareURL(payload){
  try{ const s = btoa(unescape(encodeURIComponent(JSON.stringify(payload)))); return location.origin + location.pathname + '?r=' + s; }catch(e){ return location.href; }
}
function tryReadShared(){ try{ const params = new URLSearchParams(location.search); const r = params.get('r'); if(!r) return null; return JSON.parse(decodeURIComponent(escape(atob(r)))); }catch(e){ return null; } }

function openModal(html){ modalContent.innerHTML = html; modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false'); }
function closeModal(){ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); modalContent.innerHTML = ''; }
modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

function downloadText(filename, text){ const blob = new Blob([text], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function copyToClipboard(txt){ if(navigator.clipboard) return navigator.clipboard.writeText(txt); return Promise.reject(); }

/* Certificate generation (canvas) */
function generateCertificate(name, level, scoreVal, timeRem, finalScoreVal){
  const canvas = certCanvas; const w = 1200, h = 675; canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff7f0'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle = '#111'; ctx.font = 'bold 48px sans-serif'; ctx.textAlign='center';
  ctx.fillText('Pujo ‚Äî Tap & Play', w/2, 100);
  ctx.font = '20px sans-serif'; ctx.fillText('Presented by Created and Designed by Animesh', w/2, 140);
  ctx.font = 'bold 56px sans-serif'; ctx.fillText(name, w/2, 260);
  ctx.font = '28px sans-serif'; ctx.fillStyle = '#333'; ctx.fillText(`Level ${level} ‚Ä¢ Score ${scoreVal} ‚Ä¢ Time left ${timeRem}s`, w/2, 330);
  ctx.fillText(`Final score: ${finalScoreVal}`, w/2, 370);
  canvas.toBlob(blob=>{ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = `pujo_certificate_${(name||'player').replace(/\s+/g,'_')}.png`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }, 'image/png');
}

/* =========================
   INIT
   ========================= */
(function init(){
  buildGrid(ITEMS.slice(0,4));
  statusEl.textContent = 'Ready ‚Äî press Start to enable audio.';
  backgroundPreload().catch(()=>{});
  const shared = tryReadShared();
  if(shared){
    setTimeout(()=>{ if(confirm(`Challenge from ${shared.name}: Score ${shared.score} ‚Äî open challenge?`)){ openModal(`<h3>Challenge</h3><p>${escapeHtml(shared.name)} scored ${shared.score} (final ${shared.finalScore})</p><div style="margin-top:10px"><button id="acceptChallenge" class="btn">Accept</button><button id="closeCh" class="btn">Close</button></div>`); document.getElementById('acceptChallenge').addEventListener('click', ()=>{ closeModal(); }); document.getElementById('closeCh').addEventListener('click', closeModal); } }, 600);
  }
})();
</script>
</body>
</html>
