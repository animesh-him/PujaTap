<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PujaTap ‚Äî Listen & Tap (Bengali)</title>
<style>
  :root{
    --accent:#0f172a; --muted:#666; --bg:#fff7f0;
    --header-h:84px; /* approximate header + control height */
    --credit-h:56px; /* credit bar height */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:#111}
  .wrap{max-width:1100px;margin:0 auto;padding:8px}
  header{
    position:sticky; top:0; z-index:1200;
    background:var(--bg);
    display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid #eee;
    height:auto;
  }
  .title{font-weight:900;font-size:18px}
  .subtitle{font-size:13px;color:var(--muted)}
  .controls{margin-left:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .btn{padding:3px 7px;border-radius:5px;border:1px solid #cbd5e1;background:#fff;color:#111;cursor:pointer;font-weight:800;white-space:nowrap;font-size:10px}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .pill{background:#f3f3f3;padding:6px 10px;border-radius:999px;font-weight:800;display:inline-flex;align-items:center;gap:8px;font-size:13px}
  .levels{display:flex;gap:5px;align-items:center}
  .level-btn{padding:5px 8px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:800;color:#111;font-size:10px}
  .level-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .small{font-size:10px;color:var(--muted)}
  main{min-height:0}
  .contentArea{
    overflow:auto;
    padding:8px;
    min-height: calc(100vh - var(--header-h) - var(--credit-h));
  }

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin:0 auto;max-width:1100px;padding:4px}
  @media(min-width:640px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media(min-width:900px){ .grid{grid-template-columns:repeat(4,1fr)} }

  .card{border-radius:10px;overflow:hidden;border:1px solid #eee;background:#fff;display:flex;flex-direction:column;cursor:pointer;height:120px}
  @media(min-width:640px){ .card{height:136px} }
  @media(min-width:900px){ .card{height:156px} }

  .imgwrap{height:calc(100% - 30px);overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff;padding:6px}
  .imgwrap img{width:100%;height:100%;object-fit:contain;object-position:center} /* contain ensures whole image visible */
  .label{height:30px;line-height:18px;padding:6px 8px;text-align:center;font-weight:800;font-size:12px;background:linear-gradient(180deg,transparent,rgba(255,255,255,0.9));white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .training-panel{display:none;margin:10px 0;border-radius:10px;background:#fff;border:1px solid #eee;padding:8px}
  .training-large{display:flex;align-items:center;justify-content:center;margin-bottom:8px}
  .training-large img{
    width:100%;
    max-width:820px;
    max-height: calc(100vh - var(--header-h) - 180px);
    object-fit:contain;border-radius:8px;background:#fff;
  }
  .training-controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .training-thumb-row{display:flex;gap:8px;overflow:auto;padding:6px 0}
  .thumb{flex:0 0 auto;width:76px;text-align:center}
  .thumb img{width:76px;height:58px;object-fit:cover;border-radius:6px;border:2px solid transparent}
  .thumb.current img{border-color:var(--accent)}

  .runningStatusWrap{margin-top:8px;display:flex;gap:7px;align-items:center;font-size:10px;color:var(--muted)}
  .runningLabel{font-weight:700;color:#222;margin-right:6px}

  .creditSmall{margin-top:8px;font-size:12px;color:#fff;background:#000;padding:8px;text-align:center;border-radius:6px;line-height:1.2}
  .creditSmall .tagline{display:block;font-size:11px;opacity:0.95;margin-bottom:4px}
  .creditSmall .main{font-weight:700}

  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:1600;padding:12px}
  .modal{background:#fff;padding:14px;border-radius:10px;max-width:920px;width:100%;max-height:86vh;overflow:auto;font-size:13px}
  input[type="text"]{padding:8px;border-radius:8px;border:1px solid #ddd;font-size:13px}

  @media(max-width:480px){
    :root{--header-h:104px; --credit-h:64px}
    .card{height:112px}
    .training-large img{max-height:calc(100vh - var(--header-h) - 170px)}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">üëÇ Pujo ‚Äî Listen & Tap (Bengali)</div>
      <div class="subtitle">Tap the picture that matches the spoken Bengali word.</div>
    </div>

    <div class="controls" role="region" aria-label="Top controls">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">‚è± <b id="timer">0</b>s</div>

      <button id="trainToggle" class="btn" aria-pressed="false">Training</button>
      <button id="leaderboardBtn" class="btn">Leaderboard</button>
      <button id="shareBtn" class="btn">Share</button>
      <button id="certBtn" class="btn">Certificate</button>

      <button id="startBtn" class="btn" aria-pressed="false">Start</button>
      <button id="muteBtn" class="btn">üîä On</button>
    </div>
  </header>

  <div style="margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <div id="levelsWrapper" class="levels" role="tablist" aria-label="Levels">
      <button id="lvl1" class="level-btn active" data-level="1">Level 1</button>
      <button id="lvl2" class="level-btn" data-level="2">Level 2</button>
      <button id="lvl3" class="level-btn" data-level="3">Level 3</button>
    </div>
    <div style="margin-left:8px" class="small">Level 1 ‚Äî 60s up to 15 items. Level 2 ‚Äî 120s up to 30 items. Level 3 ‚Äî 180s all items (labels hidden).</div>
    <div id="returnToPlayWrap" style="margin-left:auto;display:none"><button id="returnToPlay" class="btn">Return to Play</button></div>
  </div>

  <main>
    <div class="contentArea" id="contentArea">
      <div id="grid" class="grid" aria-live="polite" aria-label="Game grid"></div>

      <section id="trainingPanel" class="training-panel" aria-hidden="true">
        <div class="training-large">
          <img id="trainingLarge" src="" alt="Training preview">
        </div>

        <div class="training-controls">
          <button id="trainPlay" class="btn">‚ñ∂</button>
          <button id="trainPause" class="btn" disabled>‚è∏</button>
          <button id="trainPrev" class="btn">‚óÄ</button>
          <button id="trainNext" class="btn">‚ñ∂‚ñ∂</button>
          <label class="small" style="margin-left:6px">Delay:
            <select id="trainDelay" class="btn" style="padding:6px 8px;margin-left:6px">
              <option value="600">0.6s</option>
              <option value="800">0.8s</option>
              <option value="1000" selected>1.0s</option>
              <option value="1400">1.4s</option>
            </select>
          </label>
          <button id="trainStop" class="btn">Stop</button>
        </div>

        <div id="trainingPreview" class="training-thumb-row" style="margin-top:6px"></div>
      </section>

      <div class="runningStatusWrap" aria-live="polite">
        <div class="runningLabel">Running status:</div>
        <div id="status" style="color:var(--muted)">Ready ‚Äî press Start to enable audio.</div>
      </div>

      <div class="creditSmall" role="contentinfo">
        <span class="tagline">Created for all Bengalis around the Globe.</span>
        <span class="main">Created and Designed by Animesh ‚Äî Audio Credits: My daughter Ishani</span>
      </div>
    </div>
  </main>
</div>

<div id="modal" class="modal-back" role="dialog" aria-hidden="true">
  <div class="modal" id="modalContent"></div>
</div>

<canvas id="certCanvas" style="display:none"></canvas>

<script>
/* =========================
   DATA & CONFIG
   ========================= */
const ITEMS = [
  'prodip','kashphool','dhak','kansorghonta','shankho','kolabou','dhunuchi','pushpo','fol',
  'mishti','peda','batasha','alpona','chandmala','saree','punjabi','alta','trishul','bhog',
  'kosha_kushi','bel_pata','aam_pollob','tulsi_pata','padma_phool','108_prodip','pan_supari',
  'dhan','durba_ghas','chondon_kath_chondon_piri','ghot','narkel','dab','swastik_chinho',
  'sindur','gamcha','pandel','bansh','shal_pata','mondir','onusthan_suchi','roshid_ba_chandar_boi',
  'thakurer_kathamo','onjoli_ba_pushpanjoli','aroti','poncho_prodip','bangla_borno','kodma','ganda_phool',
  'siuli_phool','rosogolla'
];
const LEVELS = {1:{secs:60,maxItems:15},2:{secs:120,maxItems:30},3:{secs:180,maxItems:ITEMS.length}};
const LB_KEY = 'pujo_leaderboard_v1';

/* =========================
   UI refs & state
   ========================= */
const grid = document.getElementById('grid');
const startBtn = document.getElementById('startBtn');
const muteBtn = document.getElementById('muteBtn');
const trainToggle = document.getElementById('trainToggle');
const trainingPanel = document.getElementById('trainingPanel');
const trainingLarge = document.getElementById('trainingLarge');
const trainingPreview = document.getElementById('trainingPreview');
const trainPlay = document.getElementById('trainPlay');
const trainPause = document.getElementById('trainPause');
const trainPrev = document.getElementById('trainPrev');
const trainNext = document.getElementById('trainNext');
const trainStop = document.getElementById('trainStop');
const trainDelay = document.getElementById('trainDelay');
const contentArea = document.getElementById('contentArea');
const statusEl = document.getElementById('status');
const scoreEl = document.getElementById('score');
const timerEl = document.getElementById('timer');
const leaderboardBtn = document.getElementById('leaderboardBtn');
const shareBtn = document.getElementById('shareBtn');
const certBtn = document.getElementById('certBtn');
const levelBtns = Array.from(document.querySelectorAll('.level-btn'));
const levelsWrapper = document.getElementById('levelsWrapper');
const returnToPlayWrap = document.getElementById('returnToPlayWrap');
const returnToPlay = document.getElementById('returnToPlay');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const certCanvas = document.getElementById('certCanvas');

let selectedLevel = 1;
let playing = false;
let secs = 0;
let score = 0;
let timer = null;
let currentTarget = null;
let targetPool = [];
let audioCtx = null;
let audioBuffers = {};
let htmlAudio = {};
let preloadedImages = {};
let aggressiveAllowed = false;
let trainIndex = 0;
let trainPlaying = false;
let trainTimer = null;
let soundOn = true;
let activeSource = null;
let clickLocked = false;

/* =========================
   AUDIO / IMAGE HELPERS
   ========================= */
function ensureAudioContext(){
  if(audioCtx) return audioCtx;
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return null;
    audioCtx = new AC();
    if(audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); }
    return audioCtx;
  }catch(e){ audioCtx = null; return null; }
}
function stopAllAudio(){
  try{ if(activeSource && activeSource.stop){ try{ activeSource.stop(0); }catch(e){} activeSource = null; } }catch(e){}
  Object.values(htmlAudio).forEach(a=>{ try{ a.pause(); a.currentTime = 0; }catch(e){} });
}
async function fetchAndMaybeDecode(key){
  if(audioBuffers[key] || htmlAudio[key]) return;
  const url = `audio/bn/${key}.mp3`;
  try{
    const res = await fetch(url, {cache:'force-cache'});
    if(!res.ok) throw new Error('fetch status ' + res.status);
    const ab = await res.arrayBuffer();
    if(aggressiveAllowed && ensureAudioContext()){
      try{ const decoded = await audioCtx.decodeAudioData(ab); audioBuffers[key] = decoded; return; }catch(e){}
    }
    const a = new Audio(url); a.preload = 'auto'; htmlAudio[key] = a;
  }catch(e){
    try{ const aa = new Audio(url); aa.preload='auto'; htmlAudio[key] = aa; }catch(err){}
  }
}
function playBufferOrHtml(key){
  return new Promise(async (resolve)=>{
    if(!soundOn){ resolve(); return; }
    stopAllAudio();
    if(audioBuffers[key] && ensureAudioContext()){
      try{
        const src = audioCtx.createBufferSource();
        src.buffer = audioBuffers[key];
        const gain = audioCtx.createGain(); gain.gain.value = 1;
        src.connect(gain).connect(audioCtx.destination);
        activeSource = src;
        src.onended = ()=>{ activeSource = null; resolve(); };
        src.start(0);
        return;
      }catch(e){}
    }
    try{
      const a = htmlAudio[key] || new Audio(`audio/bn/${key}.mp3`);
      htmlAudio[key] = a;
      a.onended = ()=>resolve();
      a.onerror = ()=>{ resolve(); };
      const p = a.play();
      if(p && p.catch) p.catch(()=>resolve());
    }catch(e){ resolve(); }
  });
}
async function speakItem(key){
  if(!key) return;
  try{
    await fetchAndMaybeDecode(key);
    await playBufferOrHtml(key);
  }catch(e){
    try{
      if('speechSynthesis' in window){
        stopAllAudio();
        const u = new SpeechSynthesisUtterance(key.replace(/_/g,' '));
        u.lang = 'en-GB';
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
        await new Promise(r=>{ u.onend = r; setTimeout(r,1200); });
      }
    }catch(err){}
  }
}

/* ========== Preload strategy ========== */
function capabilityCheck(){ const mem = navigator.deviceMemory || 0; const cores = navigator.hardwareConcurrency || 0; return (mem>=4||cores>=4); }
function preloadImages(keys){ keys.forEach(k=>{ if(preloadedImages[k]) return; const img=new Image(); img.src=`images/pujo/${k}.jpg`; preloadedImages[k]=img; }); }
async function backgroundPreload(){ aggressiveAllowed = capabilityCheck(); const first = ITEMS.slice(0,6); preloadImages(first); await Promise.all(first.map(k=>fetchAndMaybeDecode(k))).catch(()=>{}); if(aggressiveAllowed){ for(let i=0;i<ITEMS.length;i+=6){ const set=ITEMS.slice(i,i+6); preloadImages(set); await Promise.all(set.map(k=>fetchAndMaybeDecode(k))).catch(()=>{}); await new Promise(r=>setTimeout(r,180)); } } else { for(let i=0;i<ITEMS.length;i+=4){ const set=ITEMS.slice(i,i+4); preloadImages(set); await Promise.all(set.map(k=>fetchAndMaybeDecode(k))).catch(()=>{}); await new Promise(r=>setTimeout(r,600)); } } }

/* helper: check quick availability of image (avoid blank tiles) */
function ensureImageAvailable(key, timeoutMs = 1000) { return new Promise((resolve) => { const url = `images/pujo/${key}.jpg`; const img = new Image(); let done = false; const to = setTimeout(()=>{ if(!done){ done = true; img.onload = img.onerror = null; resolve(false); } }, timeoutMs); img.onload = () => { if(done) return; done = true; clearTimeout(to); resolve(true); }; img.onerror = () => { if(done) return; done = true; clearTimeout(to); resolve(false); }; img.src = url; }); }

const PLACEHOLDER_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
  '<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600"><rect fill="#f3f3f3" width="100%" height="100%"/><text x="50%" y="50%" font-size="28" fill="#777" text-anchor="middle" dy="8">Image not found</text></svg>'
);

/* ===== Grid & Rounds ===== */
function buildGrid(keys){
  grid.innerHTML = '';
  const hideLabels = selectedLevel === 3;
  preloadImages(keys);
  keys.forEach((k,i)=>{
    const c = document.createElement('button'); c.className = 'card'; c.type='button'; c.dataset.key = k;
    c.setAttribute('aria-label', k);
    const iw = document.createElement('div'); iw.className = 'imgwrap';
    const img = document.createElement('img'); img.alt = k;
    if(preloadedImages[k] && preloadedImages[k].src) img.src = preloadedImages[k].src;
    else img.src = `images/pujo/${k}.jpg`;
    img.onerror = () => { img.onerror = null; img.src = PLACEHOLDER_SVG; };
    iw.appendChild(img);
    c.appendChild(iw);
    const lbl = document.createElement('div'); lbl.className = 'label'; lbl.textContent = k;
    if(hideLabels) lbl.style.display = 'none';
    c.appendChild(lbl);
    c.addEventListener('click', ()=>onTileClick(k));
    grid.appendChild(c);
  });
}

function shuffle(a){ return a.slice().map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function makeRoundPool(){
  if(!targetPool || targetPool.length === 0){
    const cfg = LEVELS[selectedLevel];
    const poolSize = Math.min(cfg.maxItems, ITEMS.length);
    targetPool = shuffle(ITEMS).slice(0, poolSize);
  }
  return targetPool.shift();
}

async function startNextRound(){
  if(!playing) return;
  let candidate = null;
  for(let attempts=0; attempts<8; attempts++){
    candidate = makeRoundPool();
    if(!candidate) break;
    const ok = await ensureImageAvailable(candidate, 900);
    if(ok) break;
    candidate = null;
  }
  if(!candidate){
    const keys = shuffle(ITEMS).slice(0,4);
    buildGrid(keys);
    currentTarget = keys[0];
    updateStatus('Listen and tap the matching image (some images unavailable)');
    await speakItem(currentTarget);
    return;
  }
  currentTarget = candidate;
  const distractors = [];
  const candidates = shuffle(ITEMS.filter(x=>x!==currentTarget));
  for(let i=0; i<candidates.length && distractors.length<3; i++){
    const d = candidates[i];
    const ok = await ensureImageAvailable(d, 700);
    if(ok) distractors.push(d);
  }
  if(distractors.length < 3){
    const extras = shuffle(ITEMS.filter(x=>x!==currentTarget && distractors.indexOf(x)===-1)).slice(0, 3 - distractors.length);
    distractors.push(...extras);
  }
  const keys = shuffle([currentTarget, ...distractors]).slice(0,4);
  buildGrid(keys);
  updateStatus('Listen and tap the matching image');
  await speakItem(currentTarget);
}

/* ===== Click handling ===== */
function onTileClick(key){
  if(clickLocked) return;
  clickLocked = true;
  setTimeout(()=>{ clickLocked = false; }, 700); // short lock to prevent spamming

  if(!playing && trainingPanel.style.display === 'block'){
    pauseTraining();
    showTrainingLarge(key);
    speakItem(key).catch(()=>{});
    return;
  }
  if(!playing) return;
  if(!currentTarget) return;

  if(key === currentTarget){
    score++; scoreEl.textContent = score;
    updateStatus('‚úÖ ' + pick(['Brilliant!','Great!','Nice!','Super!']));
  } else {
    score = Math.max(0, score-1); scoreEl.textContent = score;
    updateStatus(pick(['Almost‚Äîtry again!','So close!','Keep going!']));
  }
  // Always advance to next round (correct or incorrect) after short delay
  setTimeout(()=>{ if(playing) startNextRound(); }, 500);
}
function computeFinalScore(scoreVal, timeRem){ return (scoreVal * 1000) + Math.floor(Math.max(0,timeRem) * 5); }
function updateStatus(txt){ statusEl.textContent = txt; }

/* ===== Start / Stop / Levels ===== */
function startGame(){
  ensureAudioContext();
  stopAllAudio();
  playing = true; score = 0; scoreEl.textContent = 0;
  const cfg = LEVELS[selectedLevel];
  secs = cfg.secs; timerEl.textContent = secs;
  targetPool = shuffle(ITEMS).slice(0, Math.min(cfg.maxItems, ITEMS.length));
  updateStatus('Game started ‚Äî listen for the item');
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{
    secs--; timerEl.textContent = secs;
    if(secs <= 0){
      clearInterval(timer);
      playing = false;
      startBtn.textContent = 'Start'; startBtn.classList.remove('primary'); startBtn.setAttribute('aria-pressed','false');
      const final = computeFinalScore(score, secs);
      const msg = score < 5 ? pick(['You are my buddy ‚ù§Ô∏è Let\'s play again, shall we?','Great try!']) : pick(['Wow! You crushed it! üèÜ','Amazing score!']);
      updateStatus(`Game finished. Your score is ${score}. ${msg}`);
      saveResultToLeaderboard({name:'Anonymous',score, timeRemaining:secs, finalScore:final, level:selectedLevel, when:Date.now()});
      openResultModal(score, secs, final);
    }
  }, 1000);
  startBtn.textContent = 'Stop'; startBtn.classList.add('primary'); startBtn.setAttribute('aria-pressed','true');
  startNextRound();
}
function stopGame(){
  playing = false;
  if(timer) clearInterval(timer);
  stopAllAudio();
  startBtn.textContent = 'Start'; startBtn.classList.remove('primary'); startBtn.setAttribute('aria-pressed','false');
  updateStatus('Stopped. Press Start to play again.');
}
startBtn.addEventListener('click', ()=>{
  if(trainingPanel.style.display === 'block'){ return; } // disable start while training
  if(!playing) startGame(); else stopGame();
});
muteBtn.addEventListener('click', ()=>{ soundOn = !soundOn; muteBtn.textContent = soundOn ? 'üîä On' : 'üîá Off'; if(!soundOn) stopAllAudio(); });

levelBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    levelBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    selectedLevel = Number(b.dataset.level);
    updateStatus(`Level ${selectedLevel} selected. Press Start.`);
    buildGrid(ITEMS.slice(0,4));
  });
});

/* ===== Training ===== */
function openTraining(){
  trainingPanel.style.display = 'block';
  trainingPanel.setAttribute('aria-hidden','false');
  grid.style.display = 'none';
  trainingPreview.innerHTML = '';
  levelsWrapper.style.display = 'none';
  leaderboardBtn.style.display = 'none';
  shareBtn.style.display = 'none';
  certBtn.style.display = 'none';
  returnToPlayWrap.style.display = '';
  trainToggle.classList.add('primary'); trainToggle.setAttribute('aria-pressed','true');
  startBtn.style.display = 'none';
  renderTrainingPreview();
  trainIndex = 0;
  showTrainingLarge(ITEMS[0]);
  updateStatus('Training mode: previewing');
  // make sure header + controls visible
  setTimeout(()=>{ window.scrollTo({top:0,behavior:'smooth'}); }, 50);
}
function closeTraining(){
  trainingPanel.style.display = 'none';
  trainingPanel.setAttribute('aria-hidden','true');
  grid.style.display = '';
  levelsWrapper.style.display = '';
  leaderboardBtn.style.display = '';
  shareBtn.style.display = '';
  certBtn.style.display = '';
  returnToPlayWrap.style.display = 'none';
  trainToggle.classList.remove('primary'); trainToggle.setAttribute('aria-pressed','false');
  startBtn.style.display = '';
  stopTraining();
  updateStatus('Training closed');
}
trainToggle.addEventListener('click', ()=>{ const open = trainingPanel.style.display === 'block'; if(open) closeTraining(); else openTraining(); });

function renderTrainingPreview(){
  trainingPreview.innerHTML = '';
  ITEMS.forEach((k, idx)=>{
    const d = document.createElement('div'); d.className = 'thumb';
    const img = document.createElement('img'); img.alt = k; img.src = `images/pujo/${k}.jpg`;
    img.addEventListener('error', ()=>{ img.style.opacity = 0.45; img.src = PLACEHOLDER_SVG; });
    d.appendChild(img);
    d.addEventListener('click', ()=>{ pauseTraining(); trainIndex = idx; showTrainingLarge(k); speakItem(k); });
    trainingPreview.appendChild(d);
  });
}
function showTrainingLarge(key){
  const src = (preloadedImages[key] && preloadedImages[key].src) ? preloadedImages[key].src : `images/pujo/${key}.jpg`;
  const imgEl = document.getElementById('trainingLarge');
  imgEl.src = src;
  Array.from(trainingPreview.children).forEach((n,i)=> n.classList.toggle('current', ITEMS[i]===key));
  const idx = ITEMS.indexOf(key);
  if(idx >= 0 && trainingPreview.children[idx]) trainingPreview.children[idx].scrollIntoView({behavior:'smooth', inline:'center'});
}
async function trainingLoop(){
  while(trainPlaying){
    const key = ITEMS[trainIndex];
    showTrainingLarge(key);
    await fetchAndMaybeDecode(key).catch(()=>{});
    await speakItem(key);
    if(!trainPlaying) break;
    const delay = Number(trainDelay.value) || 1000;
    await new Promise(r => trainTimer = setTimeout(r, delay));
    trainIndex = (trainIndex + 1) % ITEMS.length;
  }
}
function startTraining(){ if(trainPlaying) return; trainPlaying = true; trainPlay.disabled=true; trainPause.disabled=false; trainingLoop(); }
function pauseTraining(){ trainPlaying = false; trainPlay.disabled=false; trainPause.disabled=true; if(trainTimer){ clearTimeout(trainTimer); trainTimer=null; } stopAllAudio(); }
function stopTraining(){ pauseTraining(); trainIndex = 0; const imgEl = document.getElementById('trainingLarge'); imgEl.src=''; Array.from(trainingPreview.children).forEach(n=> n.classList.remove('current')); }

trainPlay.addEventListener('click', ()=>{ if(trainingPanel.style.display!=='block') openTraining(); startTraining(); });
trainPause.addEventListener('click', pauseTraining);
trainNext.addEventListener('click', ()=>{ pauseTraining(); trainIndex=(trainIndex+1)%ITEMS.length; showTrainingLarge(ITEMS[trainIndex]); speakItem(ITEMS[trainIndex]); });
trainPrev.addEventListener('click', ()=>{ pauseTraining(); trainIndex=(trainIndex-1+ITEMS.length)%ITEMS.length; showTrainingLarge(ITEMS[trainIndex]); speakItem(ITEMS[trainIndex]); });
trainStop.addEventListener('click', ()=>{ stopTraining(); });

returnToPlay.addEventListener('click', ()=>{ closeTraining(); });

/* ===== Leaderboard/Share/Cert (unchanged) ===== */
function saveResultToLeaderboard(entry){
  try{ const lb = JSON.parse(localStorage.getItem(LB_KEY) || '[]'); lb.push(entry); lb.sort((a,b)=> b.finalScore - a.finalScore || b.score - a.score || a.timeRemaining - b.timeRemaining); localStorage.setItem(LB_KEY, JSON.stringify(lb.slice(0,200))); }catch(e){}
}
function loadLeaderboard(){ try{ return JSON.parse(localStorage.getItem(LB_KEY) || '[]'); }catch(e){ return []; } }

function openResultModal(scoreVal,timeRem,finalScoreVal){
  const badge = finalScoreVal >= 20000 ? 'Gold' : finalScoreVal >= 12000 ? 'Silver' : 'Bronze';
  const html = `
    <h2>Round complete</h2>
    <p>Score: <b>${scoreVal}</b> ‚Ä¢ Time remaining: <b>${timeRem}</b>s ‚Ä¢ Final score: <b>${finalScoreVal}</b></p>
    <p>Badge: <b>${badge}</b></p>
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input id="playerName" placeholder="Your name (optional)" style="padding:8px;border:1px solid #ddd;border-radius:8px;width:220px" />
      <button id="saveScoreBtn" class="btn">Save</button>
      <button id="shareLinkBtn" class="btn">Share</button>
      <button id="downloadCertBtn" class="btn">Certificate</button>
      <button id="closeModalBtn" class="btn">Close</button>
    </div>
  `;
  openModal(html);
  document.getElementById('closeModalBtn').addEventListener('click', closeModal);
  document.getElementById('saveScoreBtn').addEventListener('click', ()=>{
    const name = document.getElementById('playerName').value.trim() || 'Anonymous';
    saveResultToLeaderboard({name,score:scoreVal,timeRemaining:timeRem,finalScore:finalScoreVal,level:selectedLevel,when:Date.now()});
    alert('Saved to local leaderboard');
    closeModal();
  });
  document.getElementById('shareLinkBtn').addEventListener('click', ()=>{
    const payload = {name:(document.getElementById('playerName').value.trim()||'Anonymous'),score:scoreVal,timeRemaining:timeRem,finalScore:finalScoreVal,level:selectedLevel,when:Date.now()};
    const url = generateShareURL(payload);
    if(navigator.share){ navigator.share({title:'Pujo score',text:`I scored ${payload.score}`,url}).catch(()=>copyToClipboard(url).then(()=>alert('Link copied'))); }
    else copyToClipboard(url).then(()=>alert('Link copied')).catch(()=>prompt('Copy this link:', url));
  });
  document.getElementById('downloadCertBtn').addEventListener('click', ()=>{
    const name = document.getElementById('playerName').value.trim() || 'Anonymous';
    generateCertificate(name, selectedLevel, scoreVal, timeRem, finalScoreVal);
  });
}

leaderboardBtn.addEventListener('click', ()=>{
  const lb = loadLeaderboard();
  const rows = lb.map((r,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.score}</td><td>${r.timeRemaining}s</td><td>${r.finalScore}</td><td>${r.level}</td><td>${new Date(r.when).toLocaleString()}</td></tr>`).join('') || '<tr><td colspan="7">No entries</td></tr>';
  const html = `<h2>Local Leaderboard</h2><div style="overflow:auto"><table style="width:100%;border-collapse:collapse"><thead><tr><th>#</th><th>Name</th><th>Score</th><th>Time</th><th>Final</th><th>Level</th><th>When</th></tr></thead><tbody>${rows}</tbody></table></div><div style="margin-top:10px;display:flex;gap:8px"><button id="exportBtn" class="btn">Export JSON</button><button id="closeLB" class="btn">Close</button></div>`;
  openModal(html);
  document.getElementById('closeLB').addEventListener('click', closeModal);
  document.getElementById('exportBtn').addEventListener('click', ()=>{ const data = JSON.stringify(lb, null, 2); downloadText('pujo_leaderboard.json', data); });
});

shareBtn.addEventListener('click', ()=>{
  const lb = loadLeaderboard();
  const last = lb[0];
  if(!last){ copyToClipboard(location.href).then(()=>alert('Game link copied')); return; }
  const url = generateShareURL(last);
  copyToClipboard(url).then(()=>alert('Share link copied!'));
});

certBtn.addEventListener('click', ()=>{
  const lb = loadLeaderboard();
  if(!lb[0]){ alert('No saved result yet'); return; }
  const r = lb[0];
  generateCertificate(r.name || 'Player', r.level, r.score, r.timeRemaining, r.finalScore);
});

function generateShareURL(payload){ try{ const s = btoa(unescape(encodeURIComponent(JSON.stringify(payload)))); return location.origin + location.pathname + '?r=' + s; }catch(e){ return location.href; } }
function tryReadShared(){ try{ const params = new URLSearchParams(location.search); const r = params.get('r'); if(!r) return null; return JSON.parse(decodeURIComponent(escape(atob(r)))); }catch(e){ return null; } }

function openModal(html){ modalContent.innerHTML = html; modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false'); }
function closeModal(){ modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); modalContent.innerHTML = ''; }
modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
function downloadText(filename, text){ const blob = new Blob([text], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function copyToClipboard(txt){ if(navigator.clipboard) return navigator.clipboard.writeText(txt); return Promise.reject(); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Certificate generation (canvas) */
function generateCertificate(name, level, scoreVal, timeRem, finalScoreVal){
  const canvas = certCanvas; const w = 1200, h = 675; canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff7f0'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle = '#111'; ctx.font = 'bold 48px sans-serif'; ctx.textAlign='center';
  ctx.fillText('üÖñüÖêüÖúüÖòüÖùüÖñ üÖíüÖîüÖ°üÖ£üÖòüÖïüÖòüÖíüÖêüÖ£üÖî', w/2, 120);
  ctx.font = '20px sans-serif'; ctx.fillText('ùëÆùíÇùíéùíÜ- ùë∑ùíñùíãùíê ‚Äî ùëªùíÇùíë & ùë∑ùíçùíÇùíö (ùë∑ùíñùíãùíÇùëªùíÇùíë)', w/2, 140);
  ctx.font = '20px sans-serif'; ctx.fillText('ùí´ùìá‚ÑØùìà‚ÑØùìÉùìâ‚ÑØùíπ ùí∑ùìé ùíûùìá‚ÑØùí∂ùìâ‚Ñ¥ùìá & ùíü‚ÑØùìàùíæ‚ÑäùìÉ‚ÑØùìá ùíúùìÉùíæùìÇ‚ÑØùìàùíΩ', w/2, 170);
  ctx.font = 'bold 56px sans-serif'; ctx.fillText(name, w/2, 260);
  ctx.font = '28px sans-serif'; ctx.fillStyle = '#333'; ctx.fillText(`Level ${level} ‚Ä¢ Score ${scoreVal}`, w/2, 330);
  ctx.fillText(`Final score: ${finalScoreVal}`, w/2, 370);
  canvas.toBlob(blob=>{ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `pujo_certificate_${(name||'player').replace(/\s+/g,'_')}.png`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }, 'image/png');
}

/* ===== INIT ===== */
(function init(){
  buildGrid(ITEMS.slice(0,4));
  updateStatus('Ready ‚Äî press Start to enable audio.');
  backgroundPreload().catch(()=>{});
  const shared = tryReadShared();
  if(shared){
    setTimeout(()=>{ if(confirm(`Challenge from ${shared.name}: Score ${shared.score} ‚Äî open challenge?`)){ openModal(`<h3>Challenge</h3><p>${escapeHtml(shared.name)} scored ${shared.score} (final ${shared.finalScore})</p><div style="margin-top:10px"><button id="acceptChallenge" class="btn">Accept</button><button id="closeCh" class="btn">Close</button></div>`); document.getElementById('acceptChallenge').addEventListener('click', ()=>{ closeModal(); }); document.getElementById('closeCh').addEventListener('click', closeModal); } }, 600);
  }
})();

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

</script>
</body>
</html>
