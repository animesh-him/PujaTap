<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pujo ‚Äî Listen & Tap (Bengali)</title>
<style>
  :root{
    --accent:#0f172a;
    --muted:#666;
    --bg:#fff7f0;
    --card:#ffffff;
    --footer-h:46px;
    --footer-pad:56px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:#111}
  .wrap{max-width:1100px;margin:0 auto;padding:12px;padding-bottom:calc(var(--footer-pad));min-height:100vh}
  header{display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap}
  .title{font-weight:900;font-size:18px}
  .subtitle{font-size:13px;color:var(--muted)}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#111;cursor:pointer;font-weight:700;white-space:nowrap;font-size:14px}
  .btn.small{padding:6px 8px;font-size:13px}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .pill{background:#f3f3f3;padding:6px 10px;border-radius:999px;font-weight:800;display:inline-flex;align-items:center;gap:8px;font-size:14px}
  .levels{display:flex;gap:8px;align-items:center}
  .level-btn{padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:800;color:#111}
  .level-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  /* grid */
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
  @media(min-width:700px){ .grid{grid-template-columns:repeat(3,1fr)} }
  .card{border-radius:12px;overflow:hidden;border:1px solid #eee;background:var(--card);display:flex;flex-direction:column;cursor:pointer;height:180px}
  @media(min-width:900px){ .card{height:200px} }
  .imgwrap{height:calc(100% - 38px);overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff}
  .imgwrap img{width:100%;height:100%;object-fit:contain;object-position:center}
  .label{height:38px;line-height:18px;padding:8px;text-align:center;font-weight:800;font-size:13px;background:linear-gradient(180deg,transparent,rgba(255,255,255,0.9));white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* training */
  .training-panel{display:none;margin-top:12px;padding:10px;border-radius:12px;background:#fff;border:1px solid #eee}
  .training-large{display:flex;align-items:center;justify-content:center;margin-bottom:8px;padding-top:6px}
  .training-large img{width:100%;max-width:820px;max-height:calc(100vh - 260px);object-fit:contain;border-radius:8px}
  .training-thumb-row{display:flex;gap:8px;overflow:auto;padding:6px 0}
  .thumb{flex:0 0 auto;width:84px;text-align:center}
  .thumb img{width:84px;height:64px;object-fit:cover;border-radius:6px;border:2px solid transparent}
  .thumb.current img{border-color:var(--accent)}
  .status{margin-top:8px;padding:8px;border-radius:8px;background:#fffef8;border:1px solid #ffe8b5;font-size:14px}
  /* footer fixed small bar */
  .footer-bar{
    position:fixed;
    left:0;right:0;bottom:0;
    height:var(--footer-h);
    background:#000;color:#fff;display:flex;align-items:center;justify-content:center;padding:6px 12px;
    z-index:1200;font-size:13px;
  }
  .footer-bar .wrap-inner{max-width:1100px;width:100%;display:flex;justify-content:center;align-items:center}
  /* running status small bar above footer */
  .running-status{
    position:fixed;left:12px;right:12px;bottom:calc(var(--footer-h) + 8px);
    background:transparent;padding:0;display:flex;align-items:center;gap:8px;justify-content:center;z-index:1180;
  }
  .running-status .box{background:rgba(0,0,0,0.85);color:#fff;padding:6px 12px;border-radius:8px;font-size:13px}
  /* Return to Play sticky at top right during training */
  .return-play{position:sticky;top:12px;margin-left:auto}
  /* misc */
  .hidden{display:none !important}
  .controls-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .header-actions{display:flex;gap:8px;align-items:center}
  /* make buttons slimmer */
  .btn.slim{padding:6px 10px;border-radius:8px}
  @media(max-width:420px){
    .card{height:150px}
    .imgwrap img{max-height:calc(100vh - 320px)}
    .training-large img{max-height:calc(100vh - 260px)}
  }
</style>
</head>
<body>
<div class="wrap" id="pageWrap">
  <header id="topHeader">
    <div>
      <div class="title">üëÇ Pujo ‚Äî Listen & Tap (Bengali)</div>
      <div class="subtitle">Tap the picture that matches the spoken Bengali word.</div>
    </div>

    <div class="controls" role="region" aria-label="Top controls">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">‚è± <b id="timer">0</b>s</div>

      <div class="header-actions">
        <button id="trainToggle" class="btn slim" aria-pressed="false">Training</button>
        <button id="returnPlay" class="btn slim hidden">Return to Play</button>
        <button id="leaderboardBtn" class="btn slim">Leaderboard</button>
        <button id="shareBtn" class="btn slim">Share</button>
        <button id="certBtn" class="btn slim">Certificate</button>
        <button id="startBtn" class="btn primary slim">Start</button>
        <button id="muteBtn" class="btn slim">üîä On</button>
      </div>
    </div>
  </header>

  <div id="levelsWrapper" style="margin-top:10px">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <div class="levels" role="tablist" aria-label="Levels" id="levelsRow">
        <button id="lvl1" class="level-btn active" data-level="1">Level 1</button>
        <button id="lvl2" class="level-btn" data-level="2">Level 2</button>
        <button id="lvl3" class="level-btn" data-level="3">Level 3</button>
      </div>
      <div class="small" id="levelDesc">Level 1 ‚Äî 60s up to 15 items. Level 2 ‚Äî 120s up to 30 items. Level 3 ‚Äî 180s all items (labels hidden).</div>
    </div>
  </div>

  <main>
    <div id="grid" class="grid" aria-live="polite" aria-label="Game grid">
      <!-- tiles injected here -->
    </div>

    <section id="trainingPanel" class="training-panel" aria-hidden="true">
      <div class="training-large">
        <img id="trainingLarge" src="" alt="Training preview">
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
        <button id="trainPlay" class="btn small">‚ñ∂</button>
        <button id="trainPause" class="btn small" disabled>‚è∏</button>
        <button id="trainPrev" class="btn small">‚óÄ</button>
        <button id="trainNext" class="btn small">‚ñ∂‚ñ∂</button>
        <label class="small" style="margin-left:8px">Delay:
          <select id="trainDelay" class="btn small" style="padding:6px 8px;margin-left:6px">
            <option value="600">0.6s</option>
            <option value="800">0.8s</option>
            <option value="1000" selected>1.0s</option>
            <option value="1400">1.4s</option>
          </select>
        </label>
        <button id="trainStop" class="btn small">Stop</button>
      </div>
      <div id="trainingPreview" class="training-thumb-row" style="margin-top:6px"></div>
    </section>

    <div id="status" class="status" aria-live="polite" style="display:block;margin-top:10px">Ready ‚Äî press Start to begin. (Audio will be enabled by Start.)</div>
  </main>
</div>

<!-- Running status + footer fixed bars -->
<div class="running-status" id="runningStatusWrapper" aria-hidden="false">
  <div class="box" id="runningStatus">Status: Ready</div>
</div>

<div class="footer-bar" role="contentinfo" aria-hidden="false">
  <div class="wrap-inner">
    <div style="text-align:center;white-space:pre-line;font-size:12px;max-width:980px">
      Created by Bengali ‚Äî For the Bengalis around the globe.
      <br>
      Created and Designed by Animesh ‚Äî Audio Credits: Ishani
    </div>
  </div>
</div>

<!-- modal -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1400;align-items:center;justify-content:center;padding:12px">
  <div id="modalContent" style="background:#fff;padding:12px;border-radius:8px;max-height:80vh;overflow:auto;max-width:760px;width:100%"></div>
</div>

<!-- hidden canvas for certificates -->
<canvas id="certCanvas" style="display:none"></canvas>

<script>
/* =========================
   CONFIG & DATA
   ========================= */
const ITEMS = [
  'prodip','kashphool','dhak','kansorghonta','shankho','kolabou','dhunuchi','pushpo','fol',
  'mishti','peda','batasha','alpona','chandmala','saree','punjabi','alta','trishul','bhog',
  'kosha_kushi','bel_pata','aam_pollob','tulsi_pata','padma_phool','108_prodip','pan_supari',
  'dhan','durba_ghas','chondon_kath_chondon_piri','ghot','narkel','dab','swastik_chinho',
  'sindur','gamcha','pandel','bansh','shal_pata','mondir','onusthan_suchi','roshid_ba_chandar_boi',
  'thakurer_kathamo','onjoli_ba_pushpanjoli','aroti','poncho_prodip'
];
const LEVELS = {1:{secs:60,maxItems:15},2:{secs:120,maxItems:30},3:{secs:180,maxItems:ITEMS.length}};
const LB_KEY = 'pujo_leaderboard_v1';

/* =========================
   UI refs & state
   ========================= */
const grid = document.getElementById('grid');
const startBtn = document.getElementById('startBtn');
const muteBtn = document.getElementById('muteBtn');
const trainToggle = document.getElementById('trainToggle');
const returnPlay = document.getElementById('returnPlay');
const trainingPanel = document.getElementById('trainingPanel');
const trainingLarge = document.getElementById('trainingLarge');
const trainingPreview = document.getElementById('trainingPreview');
const trainPlay = document.getElementById('trainPlay');
const trainPause = document.getElementById('trainPause');
const trainPrev = document.getElementById('trainPrev');
const trainNext = document.getElementById('trainNext');
const trainStop = document.getElementById('trainStop');
const trainDelay = document.getElementById('trainDelay');
const statusEl = document.getElementById('status');
const runningStatus = document.getElementById('runningStatus');
const scoreEl = document.getElementById('score');
const timerEl = document.getElementById('timer');
const leaderboardBtn = document.getElementById('leaderboardBtn');
const shareBtn = document.getElementById('shareBtn');
const certBtn = document.getElementById('certBtn');
const levelBtns = Array.from(document.querySelectorAll('.level-btn'));
const levelsRow = document.getElementById('levelsRow');
const levelDesc = document.getElementById('levelDesc');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const certCanvas = document.getElementById('certCanvas');

let selectedLevel = 1;
let playing = false;
let secs = 0;
let score = 0;
let timer = null;
let currentTarget = null;
let targetPool = [];
let audioCtx = null;
let audioBuffers = {};
let htmlAudio = {};
let preloadedImages = {};
let aggressiveAllowed = false;
let trainIndex = 0;
let trainPlaying = false;
let trainTimer = null;
let soundOn = true;

/* =========================
   Helpers
   ========================= */
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function log(){ /* debug silenced */ }

/* =========================
   Audio: fetch & playback (mp3 under audio/bn/<key>.mp3)
   ========================= */
function ensureAudioContext(){
  if(audioCtx) return audioCtx;
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return null;
    audioCtx = new AC();
    if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    return audioCtx;
  }catch(e){ audioCtx = null; return null; }
}
let activeSource = null;
function stopAllAudio(){
  try{
    if(activeSource && activeSource.stop){ try{ activeSource.stop(0); }catch(e){} activeSource=null; }
  }catch(e){}
  Object.values(htmlAudio).forEach(a=>{ try{ a.pause(); a.currentTime = 0; }catch(e){} });
}
async function fetchAndMaybeDecode(key){
  if(audioBuffers[key] || htmlAudio[key]) return;
  const url = `audio/bn/${key}.mp3`;
  try{
    const res = await fetch(url, {cache:'force-cache'});
    if(!res.ok) throw new Error('fetch '+res.status);
    const ab = await res.arrayBuffer();
    if(aggressiveAllowed && ensureAudioContext()){
      try{
        const decoded = await audioCtx.decodeAudioData(ab);
        audioBuffers[key] = decoded;
        return;
      }catch(e){}
    }
    const a = new Audio(url);
    a.preload='auto'; htmlAudio[key]=a;
  }catch(e){
    try{ const a2 = new Audio(url); a2.preload='auto'; htmlAudio[key]=a2; }catch(err){}
  }
}
function playBufferOrHtml(key){
  return new Promise(async resolve=>{
    if(!soundOn){ resolve(); return; }
    stopAllAudio();
    if(audioBuffers[key] && ensureAudioContext()){
      try{
        const src = audioCtx.createBufferSource();
        src.buffer = audioBuffers[key];
        const gain = audioCtx.createGain(); gain.gain.value = 1;
        src.connect(gain).connect(audioCtx.destination);
        activeSource = src;
        src.onended = ()=>{ activeSource=null; resolve(); };
        src.start(0);
        return;
      }catch(e){}
    }
    try{
      const a = htmlAudio[key] || new Audio(`audio/bn/${key}.mp3`);
      htmlAudio[key] = a;
      a.onended = ()=>resolve();
      a.onerror = ()=>resolve();
      const p = a.play();
      if(p && p.catch) p.catch(()=>resolve());
    }catch(e){ resolve(); }
  });
}
async function speakItem(key){
  if(!key) return;
  try{
    await fetchAndMaybeDecode(key).catch(()=>{});
    await playBufferOrHtml(key);
  }catch(e){
    // fallback TTS english-ish
    try{
      stopAllAudio();
      if('speechSynthesis' in window){
        const u = new SpeechSynthesisUtterance(key.replace(/_/g,' '));
        u.lang='en-GB'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
        await new Promise(r=>{ u.onend=r; setTimeout(r,1200); });
      }
    }catch(err){}
  }
}

/* =========================
   Preload & capability check
   ========================= */
function capabilityCheck(){
  const mem = navigator.deviceMemory || 0;
  const cores = navigator.hardwareConcurrency || 0;
  if(mem >= 4 || cores >= 4) return true;
  return false;
}
function preloadImages(keys){
  keys.forEach(k=>{
    if(preloadedImages[k]) return;
    const img = new Image();
    img.src = `images/pujo/${k}.jpg`;
    preloadedImages[k] = img;
  });
}
async function backgroundPreload(){
  aggressiveAllowed = capabilityCheck();
  const first = ITEMS.slice(0,6);
  preloadImages(first);
  await Promise.all(first.map(k=>fetchAndMaybeDecode(k))).catch(()=>{});
  if(aggressiveAllowed){
    const batch = 6;
    for(let i=0;i<ITEMS.length;i+=batch){
      const set = ITEMS.slice(i,i+batch);
      preloadImages(set);
      await Promise.all(set.map(k=>fetchAndMaybeDecode(k))).catch(()=>{});
      await new Promise(r=>setTimeout(r,180));
    }
  } else {
    for(let i=0;i<ITEMS.length;i+=4){
      const set = ITEMS.slice(i,i+4);
      preloadImages(set);
      await Promise.all(set.map(k=>fetchAndMaybeDecode(k))).catch(()=>{});
      await new Promise(r=>setTimeout(r,600));
    }
  }
}

/* =========================
   Grid build & game flow
   ========================= */
function shuffle(a){ return a.slice().map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function buildGrid(keys){
  grid.innerHTML='';
  const hideLabels = selectedLevel === 3;
  preloadImages(keys);
  keys.forEach(k=>{
    const c = document.createElement('button'); c.className='card'; c.type='button'; c.dataset.key=k;
    const iw = document.createElement('div'); iw.className='imgwrap';
    const img = document.createElement('img'); img.alt=k;
    img.src = preloadedImages[k] && preloadedImages[k].src ? preloadedImages[k].src : `images/pujo/${k}.jpg`;
    img.onerror = ()=>{ img.style.opacity=0.4; };
    iw.appendChild(img); c.appendChild(iw);
    const lbl = document.createElement('div'); lbl.className='label'; lbl.textContent = k;
    if(hideLabels) lbl.style.display='none';
    c.appendChild(lbl);
    c.addEventListener('click', ()=>onTileClick(k));
    grid.appendChild(c);
  });
  // adjust layout so header + footer + running status remain visible
  adjustBodyPadding();
}

function makeRoundPool(){
  const cfg = LEVELS[selectedLevel];
  const poolSize = Math.min(cfg.maxItems, ITEMS.length);
  targetPool = shuffle(ITEMS).slice(0, poolSize);
  return targetPool.shift();
}
async function startNextRound(){
  if(!playing) return;
  currentTarget = makeRoundPool();
  const distractors = shuffle(ITEMS.filter(x=>x!==currentTarget)).slice(0, (selectedLevel===3?8:5));
  const keys = shuffle([currentTarget, ...distractors]).slice(0,4); // show 4 tiles to fit mobile
  buildGrid(keys);
  runningStatus.textContent = 'Status: Listen and tap the matching image';
  await speakItem(currentTarget);
}
function onTileClick(key){
  if(!playing && trainingPanel.style.display === 'block'){
    // in training mode: play that item's audio and show it large
    pauseTraining();
    showTrainingLarge(key);
    speakItem(key);
    return;
  }
  if(!playing || !currentTarget) return;
  if(key === currentTarget){
    score++; scoreEl.textContent = score;
    statusEl.textContent = '‚úÖ ' + pick(['Brilliant!','Great!','Nice!','Super!']);
    setTimeout(()=>{ if(playing) startNextRound(); }, 400);
  } else {
    score = Math.max(0, score-1); scoreEl.textContent = score;
    statusEl.textContent = pick(['Almost‚Äîtry again!','So close!','Keep going!']);
  }
}
function computeFinalScore(scoreVal, timeRem){
  return (scoreVal * 1000) + Math.floor(timeRem*5);
}

/* =========================
   Controls
   ========================= */
function startGame(){
  ensureAudioContext();
  stopAllAudio();
  playing = true; score = 0; scoreEl.textContent = 0;
  const cfg = LEVELS[selectedLevel];
  secs = cfg.secs; timerEl.textContent = secs;
  targetPool = shuffle(ITEMS).slice(0, Math.min(cfg.maxItems, ITEMS.length));
  statusEl.textContent = 'Game started ‚Äî listen for the item';
  startBtn.textContent = 'Stop';
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{
    secs--; timerEl.textContent = secs;
    if(secs <= 0){
      clearInterval(timer);
      playing = false;
      startBtn.textContent = 'Start';
      const final = computeFinalScore(score, secs);
      const msg = score < 5 ? pick(['You are my buddy ‚ù§Ô∏è Let\'s play again, shall we?','Great try!']) : pick(['Wow! You crushed it! üèÜ','Amazing score!']);
      statusEl.textContent = `Time‚Äôs up: Your score is ${score}. ${msg}`;
      runningStatus.textContent = `Round complete ‚Äî Your score: ${score}`;
      saveResultToLeaderboard({name:'Anonymous',score,timeRemaining:secs,finalScore:final,level:selectedLevel,when:Date.now()});
      openResultModal(score, secs, final);
    }
  },1000);
  startNextRound();
}
function stopGame(){
  playing = false;
  if(timer) clearInterval(timer);
  startBtn.textContent = 'Start';
  runningStatus.textContent = 'Stopped';
  stopAllAudio();
}

startBtn.addEventListener('click', ()=>{
  ensureAudioContext();
  if(playing) stopGame(); else startGame();
});

muteBtn.addEventListener('click', ()=>{
  soundOn = !soundOn;
  muteBtn.textContent = soundOn ? 'üîä On' : 'üîá Off';
  if(!soundOn) stopAllAudio();
});

levelBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    levelBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    selectedLevel = Number(b.dataset.level);
    statusEl.textContent = `Level ${selectedLevel} selected. Press Start.`;
    buildGrid(ITEMS.slice(0,4)); // preview 4 items
  });
});

/* =========================
   Training module
   ========================= */
function openTraining(){
  trainingPanel.style.display='block';
  trainingPanel.setAttribute('aria-hidden','false');
  // hide levels while training
  levelsRow.style.display='none';
  levelDesc.style.display='none';
  returnPlay.classList.remove('hidden');
  trainToggle.classList.add('primary');
  // ensure header stays visible and training preview fits
  buildTrainingPreview();
  trainIndex = 0;
  showTrainingLarge(ITEMS[0]);
  runningStatus.textContent = 'Status: Training mode: previewing';
  // reduce image heights to ensure header/preview/footer always visible
  document.querySelectorAll('.training-large img').forEach(i => i.style.maxHeight = 'calc(100vh - 240px)');
  window.scrollTo({top:0,behavior:'smooth'});
}
function closeTraining(){
  trainingPanel.style.display='none';
  trainingPanel.setAttribute('aria-hidden','true');
  levelsRow.style.display='';
  levelDesc.style.display='';
  returnPlay.classList.add('hidden');
  trainToggle.classList.remove('primary');
  pauseTraining();
  runningStatus.textContent = 'Status: Ready';
  buildGrid(ITEMS.slice(0,4));
}
trainToggle.addEventListener('click', ()=>{
  if(trainingPanel.style.display === 'block') closeTraining(); else openTraining();
});
returnPlay.addEventListener('click', ()=>{ closeTraining(); });

function buildTrainingPreview(){
  trainingPreview.innerHTML='';
  ITEMS.forEach((k, idx)=>{
    const d = document.createElement('div'); d.className='thumb';
    const img = document.createElement('img'); img.alt=k; img.src = `images/pujo/${k}.jpg`;
    img.addEventListener('error', ()=>{ img.style.opacity=0.4; });
    d.appendChild(img);
    d.addEventListener('click', ()=>{ pauseTraining(); trainIndex = idx; showTrainingLarge(k); speakItem(k); });
    trainingPreview.appendChild(d);
  });
}
function showTrainingLarge(key){
  const s = preloadedImages[key] && preloadedImages[key].src ? preloadedImages[key].src : `images/pujo/${key}.jpg`;
  trainingLarge.querySelector('img').src = s;
  Array.from(trainingPreview.children).forEach((n,i)=> n.classList.toggle('current', ITEMS[i]===key));
  const idx = ITEMS.indexOf(key);
  if(idx >= 0) trainingPreview.children[idx].scrollIntoView({behavior:'smooth', inline:'center'});
}

async function trainingLoop(){
  while(trainPlaying){
    const key = ITEMS[trainIndex];
    showTrainingLarge(key);
    await fetchAndMaybeDecode(key).catch(()=>{});
    await speakItem(key);
    if(!trainPlaying) break;
    const delay = Number(trainDelay.value) || 1000;
    await new Promise(r => trainTimer = setTimeout(r, delay));
    trainIndex = (trainIndex + 1) % ITEMS.length;
  }
  if(!trainPlaying){
    // paused or stopped
  } else {
    // finished loop (if ever)
    runningStatus.textContent = 'Training finished ‚Äî You are ready for the game now. Start playing!';
    await new Promise(r=>setTimeout(r,800));
  }
}
function startTraining(){ if(trainPlaying) return; trainPlaying=true; trainPlay.disabled=true; trainPause.disabled=false; trainingLoop(); runningStatus.textContent='Status: Training running'; }
function pauseTraining(){ trainPlaying=false; trainPlay.disabled=false; trainPause.disabled=true; if(trainTimer){ clearTimeout(trainTimer); trainTimer=null; } stopAllAudio(); }
function stopTraining(){ pauseTraining(); trainIndex=0; trainingLarge.querySelector('img').src=''; Array.from(trainingPreview.children).forEach(n=> n.classList.remove('current')); runningStatus.textContent='Training stopped'; }

trainPlay.addEventListener('click', ()=>{ if(trainingPanel.style.display!=='block') openTraining(); startTraining(); });
trainPause.addEventListener('click', pauseTraining);
trainNext.addEventListener('click', ()=>{ pauseTraining(); trainIndex=(trainIndex+1)%ITEMS.length; showTrainingLarge(ITEMS[trainIndex]); speakItem(ITEMS[trainIndex]); });
trainPrev.addEventListener('click', ()=>{ pauseTraining(); trainIndex=(trainIndex-1+ITEMS.length)%ITEMS.length; showTrainingLarge(ITEMS[trainIndex]); speakItem(ITEMS[trainIndex]); });
trainStop.addEventListener('click', ()=>{ stopTraining(); });

/* =========================
   Leaderboard, sharing, certificates
   ========================= */
function saveResultToLeaderboard(entry){
  try{
    const lb = JSON.parse(localStorage.getItem(LB_KEY) || '[]');
    lb.push(entry);
    lb.sort((a,b)=> b.finalScore - a.finalScore || b.score - a.score || a.timeRemaining - b.timeRemaining);
    localStorage.setItem(LB_KEY, JSON.stringify(lb.slice(0,200)));
  }catch(e){}
}
function loadLeaderboard(){ try{ return JSON.parse(localStorage.getItem(LB_KEY) || '[]'); }catch(e){ return []; } }

function openResultModal(scoreVal,timeRem,finalScoreVal){
  const badge = finalScoreVal >= 20000 ? 'Gold' : finalScoreVal >= 12000 ? 'Silver' : 'Bronze';
  const html = `
    <h2>Round complete</h2>
    <p>Score: <b>${scoreVal}</b> ‚Ä¢ Time remaining: <b>${timeRem}</b>s ‚Ä¢ Final score: <b>${finalScoreVal}</b></p>
    <p>Badge: <b>${badge}</b></p>
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input id="playerName" placeholder="Your name (optional)" style="padding:8px;border:1px solid #ddd;border-radius:8px;width:220px" />
      <button id="saveScoreBtn" class="btn">Save</button>
      <button id="shareLinkBtn" class="btn">Share</button>
      <button id="downloadCertBtn" class="btn">Certificate</button>
      <button id="closeModalBtn" class="btn">Close</button>
    </div>
  `;
  openModal(html);
  document.getElementById('closeModalBtn').addEventListener('click', closeModal);
  document.getElementById('saveScoreBtn').addEventListener('click', ()=>{
    const name = document.getElementById('playerName').value.trim() || 'Anonymous';
    saveResultToLeaderboard({name,score:scoreVal,timeRemaining:timeRem,finalScore:finalScoreVal,level:selectedLevel,when:Date.now()});
    alert('Saved to local leaderboard');
    closeModal();
  });
  document.getElementById('shareLinkBtn').addEventListener('click', ()=>{
    const payload = {name:(document.getElementById('playerName').value.trim()||'Anonymous'),score:scoreVal,timeRemaining:timeRem,finalScore:finalScoreVal,level:selectedLevel,when:Date.now()};
    const url = generateShareURL(payload);
    if(navigator.share){ navigator.share({title:'Pujo score',text:`I scored ${payload.score}`,url}).catch(()=>copyToClipboard(url).then(()=>alert('Link copied'))); }
    else copyToClipboard(url).then(()=>alert('Link copied')).catch(()=>prompt('Copy this link:', url));
  });
  document.getElementById('downloadCertBtn').addEventListener('click', ()=>{
    const name = document.getElementById('playerName').value.trim() || 'Anonymous';
    generateCertificate(name, selectedLevel, scoreVal, timeRem, finalScoreVal);
  });
}

leaderboardBtn.addEventListener('click', ()=>{
  const lb = loadLeaderboard();
  const rows = lb.map((r,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.score}</td><td>${r.timeRemaining}s</td><td>${r.finalScore}</td><td>${r.level}</td><td>${new Date(r.when).toLocaleString()}</td></tr>`).join('') || '<tr><td colspan="7">No entries</td></tr>';
  const html = `<h2>Local Leaderboard</h2><div style="overflow:auto"><table style="width:100%;border-collapse:collapse"><thead><tr><th>#</th><th>Name</th><th>Score</th><th>Time</th><th>Final</th><th>Level</th><th>When</th></tr></thead><tbody>${rows}</tbody></table></div><div style="margin-top:10px;display:flex;gap:8px"><button id="exportBtn" class="btn">Export JSON</button><button id="closeLB" class="btn">Close</button></div>`;
  openModal(html);
  document.getElementById('closeLB').addEventListener('click', closeModal);
  document.getElementById('exportBtn').addEventListener('click', ()=>{ const data = JSON.stringify(lb, null, 2); downloadText('pujo_leaderboard.json', data); });
});

shareBtn.addEventListener('click', ()=>{
  const lb = loadLeaderboard();
  const last = lb[0];
  if(!last){ copyToClipboard(location.href).then(()=>alert('Game link copied')); return; }
  const url = generateShareURL(last);
  copyToClipboard(url).then(()=>alert('Share link copied!'));
});

certBtn.addEventListener('click', ()=>{
  const lb = loadLeaderboard();
  if(!lb[0]){ alert('No saved result yet'); return; }
  const r = lb[0];
  generateCertificate(r.name || 'Player', r.level, r.score, r.timeRemaining, r.finalScore);
});

function generateShareURL(payload){
  try{ const s = btoa(unescape(encodeURIComponent(JSON.stringify(payload)))); return location.origin + location.pathname + '?r=' + s; }catch(e){ return location.href; }
}
function tryReadShared(){ try{ const params = new URLSearchParams(location.search); const r = params.get('r'); if(!r) return null; return JSON.parse(decodeURIComponent(escape(atob(r)))); }catch(e){ return null; } }
function openModal(html){ modalContent.innerHTML = html; modal.style.display='flex'; }
function closeModal(){ modal.style.display='none'; modalContent.innerHTML=''; }
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
function downloadText(filename, text){ const blob = new Blob([text], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function copyToClipboard(txt){ if(navigator.clipboard) return navigator.clipboard.writeText(txt); return Promise.reject(); }

/* Certificate generation */
function generateCertificate(name, level, scoreVal, timeRem, finalScoreVal){
  const canvas = certCanvas; const w=1200,h=675; canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d');
  ctx.fillStyle = '#fff7f0'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle = '#111'; ctx.font='bold 48px sans-serif'; ctx.textAlign='center';
  ctx.fillText('Pujo ‚Äî Tap & Play', w/2, 100);
  ctx.font='20px sans-serif'; ctx.fillText('Created and Designed by Animesh', w/2, 140);
  ctx.font='bold 56px sans-serif'; ctx.fillText(name, w/2, 260);
  ctx.font='28px sans-serif'; ctx.fillStyle='#333'; ctx.fillText(`Level ${level} ‚Ä¢ Score ${scoreVal} ‚Ä¢ Time left ${timeRem}s`, w/2, 330);
  ctx.fillText(`Final score: ${finalScoreVal}`, w/2, 370);
  canvas.toBlob(blob=>{ const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`pujo_certificate_${(name||'player').replace(/\s+/g,'_')}.png`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }, 'image/png');
}

/* =========================
   Utils: layout adjustments so header+footer visible
   ========================= */
function adjustBodyPadding(){
  // ensure the bottom footer doesn't hide content
  const footerPad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--footer-pad')) || 56;
  document.querySelector('.wrap').style.paddingBottom = footerPad + 'px';
}

/* =========================
   Init & first render
   ========================= */
(function init(){
  // initial small grid
  buildGrid(ITEMS.slice(0,4));
  statusEl.textContent = 'Ready ‚Äî press Start to enable audio.';
  runningStatus.textContent = 'Status: Ready';
  backgroundPreload().catch(()=>{});
  const shared = tryReadShared();
  if(shared){
    setTimeout(()=>{ if(confirm(`Challenge from ${shared.name}: Score ${shared.score} ‚Äî open challenge?`)){ openModal(`<h3>Challenge</h3><p>${escapeHtml(shared.name)} scored ${shared.score} (final ${shared.finalScore})</p><div style="margin-top:10px"><button id="acceptChallenge" class="btn">Accept</button><button id="closeCh" class="btn">Close</button></div>`); document.getElementById('acceptChallenge').addEventListener('click', ()=>{ closeModal(); }); document.getElementById('closeCh').addEventListener('click', closeModal); } }, 600);
  }
})();
</script>
</body>
</html>
